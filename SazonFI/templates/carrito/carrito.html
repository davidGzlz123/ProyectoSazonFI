{% extends 'base.html' %}

{% block content %}
<div id="app-carrito" class="container mt-5">
    <h1 style="margin: 0px;">Tu carrito te llama ...</h1>

    <div v-if="loading" class="alert alert-info mt-3">
        Cargando carrito...
    </div>

    <div v-if="error" class="alert alert-danger mt-3">
        Error al cargar el carrito: {{ error }}
    </div>

    <div v-if="!loading && !error && carrito && carrito.items && carrito.items.length > 0" class="row">
        <!-- Productos carrito -->
        <div class="col-md-8">
            <div class="table-responsive"> 
            <table class="table table-hover mt-3 text-center infoTable">
            <thead class=" name-list"> 
                <!-- head-light -->
                <tr>
                <th scope="col">Producto</th>
                <th scope="col">Negocio</th>
                <th scope="col">Cantidad</th>
                <th scope="col">Precio Unitario</th>
                <th scope="col">Subtotal</th>
                <th scope="col">Acciones</th>
                </tr>
            </thead>
            <tbody>
                <tr v-for="item in carrito.items" :key="item.id">
                <td v-text="item.producto ? item.producto.nombre : 'Producto Desconocido'"></td>
                <td v-text="item.negocio ? item.negocio.nombre : 'N/A'"></td>
                <td class="text-center">
                    <input
                    type="number"
                    v-model.number="item.cantidad"
                    @change="actualizarCantidad(item)"
                    min="1"
                    class="form-control form-control-sm"
                    style="width: 70px; display: inline-block;"
                    >
                </td>
                <td class="text-right"
                    v-text=" item.precio_al_agregar != null
                            ? '$' + parseFloat(item.precio_al_agregar).toFixed(2)
                            : '$0.00' ">
                </td>
                <td class="text-right"
                    v-text=" item.subtotal != null
                            ? '$' + parseFloat(item.subtotal).toFixed(2)
                            : '$0.00' ">
                </td>
                <td class="text-center">
                    <button
                    @click="eliminarItem(item.id)"
                    class="btn btn-danger btn-sm"
                    >
                    <img src="{{ MEDIA_URL }}principal/trash.png" alt="Eliminar producto" width="30" height="30">
                    </button>
                </td>
                </tr>
            </tbody>
            <!-- ¡NO más <tfoot> aquí! -->
            </table>
            </div>
        </div>

        <!-- Total -->
        <div class="total-block totalDiv">
            <div class="total-header text-center"><h3>Total del carrito</h3></div>
            <div class="divtext-bt text-center">
                <p class="total-text" style="font-size: 30px;">
                    {{ carrito.total_carrito != null 
                        ? '$' + parseFloat(carrito.total_carrito).toFixed(2)
                        : '$0.00' }}
                </p>

                <!-- Forma de pago -->
                <form id="form-pago">
                    <h5>Selecciona tu método de pago:</h5>
                    <label>
                        <input type="radio" name="pago" value="efectivo">
                        Efectivo
                    </label><br>
                    <label>
                        <input type="radio" name="pago" value="tarjeta">
                        Tarjeta de crédito o débito
                    </label><br>
                    <label>
                        <input type="radio" name="pago" value="transferencia">
                        Transferencia bancaria
                    </label>
                </form>

                <button @click="procederAlPago" class="btn-pedido" :disabled="creandoPedido">
                    <span v-if="creandoPedido">Procesando...</span>
                    <span v-else>Hacer Pedido</span>
                </button>
            </div>
        </div>

    </div>


    <div v-if="!loading && !error && (!carrito || !carrito.items || carrito.items.length === 0)" class="alert alert-secondary mt-3">
        Tu carrito esta vacio. ¡Ve a explorar nuestros productos!
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script>
    // Funcion para obtener el valor de una cookie (para CSRF si es necesario)
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    window.addEventListener('busqueda-cambiada', e => {
    const term = e.detail;
    // Redirigir a la lista principal filtrada
    window.location.href = `/?q=${encodeURIComponent(term)}`;
    });


    const appCarrito = new Vue({
        el: '#app-carrito',
        data: {
            carrito: null,
            loading: true,
            error: null,
            token: localStorage.getItem('token'),
            creandoPedido: false
        },
        computed: {
            apiHeaders() {
                const headers = {
                    'Authorization': `Token ${this.token}`,
                    'Content-Type': 'application/json'
                };
                if (csrftoken) {
                    headers['X-CSRFToken'] = csrftoken;
                }
                return headers;
            }
        },
        mounted() {
            if (!this.token) {
                this.error = "Debes iniciar sesion para ver tu carrito.";
                this.loading = false;
                return;
            }
            this.fetchCarrito();
        },
        methods: {
            fetchCarrito() {
                this.loading = true;
                this.error = null;
                fetch('/api/carrito/', {
                    headers: {
                        'Authorization': `Token ${this.token}`
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json()
                                .then(errData => {
                                    const errorMessage = errData.detail || errData.error || JSON.stringify(errData);
                                    throw new Error(errorMessage || `Error HTTP ${response.status} al obtener el carrito.`);
                                })
                                .catch(() => {
                                    throw new Error(`Error HTTP ${response.status} al obtener el carrito. Respuesta no es JSON.`);
                                });
                        }
                        return response.json();
                    })
                    .then(data => {
                        this.carrito = data;
                        console.log('Carrito cargado:', JSON.parse(JSON.stringify(this.carrito)));
                        if (this.carrito && this.carrito.items && this.carrito.items.length > 0) {
                            console.log('Primer item del carrito (para depurar nombres):', JSON.parse(JSON.stringify(this.carrito.items[0])));
                            if (this.carrito.items[0].producto) {
                                console.log('Producto del primer item:', JSON.parse(JSON.stringify(this.carrito.items[0].producto)));
                            }
                            if (this.carrito.items[0].negocio) {
                                console.log('Negocio del primer item:', JSON.parse(JSON.stringify(this.carrito.items[0].negocio)));
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error en fetchCarrito:', error);
                        this.error = error.message;
                    })
                    .finally(() => {
                        this.loading = false;
                    });
            },
            actualizarCantidad(item) {
                console.log('Actualizar cantidad para item ID:', item.id, 'a nueva cantidad:', item.cantidad);
                if (!item || typeof item.cantidad !== 'number' || item.cantidad < 1) {
                    alert("La cantidad debe ser al menos 1.");
                    this.fetchCarrito();
                    return;
                }

                fetch(`/api/carrito-items/${item.id}/`, {
                    method: 'PATCH',
                    headers: this.apiHeaders,
                    body: JSON.stringify({ cantidad: item.cantidad })
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errData => {
                                const msg = errData.detail || errData.cantidad || JSON.stringify(errData);
                                throw new Error(msg || `Error ${response.status}`);
                            }).catch(() => { throw new Error(`Error ${response.status} actualizando cantidad.`); });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Cantidad actualizada en backend:', data);
                        this.fetchCarrito();
                    })
                    .catch(error => {
                        console.error("Error actualizando cantidad:", error);
                        alert(`Error actualizando cantidad: ${error.message}`);
                        this.fetchCarrito();
                    });
            },
            eliminarItem(itemId) {
                console.log('Intentando eliminar item ID:', itemId);
                if (!confirm("¿Estas seguro de que quieres eliminar este producto del carrito?")) {
                    return;
                }
                fetch(`/api/carrito-items/${itemId}/`, {
                    method: 'DELETE',
                    headers: this.apiHeaders
                })
                    .then(response => {
                        if (response.status === 204) {
                            console.log('Item eliminado exitosamente del backend.');
                            this.fetchCarrito();
                        } else if (!response.ok) {
                            return response.json().then(errData => {
                                throw new Error(errData.detail || JSON.stringify(errData) || `Error ${response.status}`);
                            }).catch(() => { throw new Error(`Error ${response.status} eliminando item.`); });
                        } else {
                            console.warn("Respuesta inesperada al eliminar item:", response);
                            this.fetchCarrito();
                        }
                    })
                    .catch(error => {
                        console.error("Error eliminando item:", error);
                        alert(`Error al eliminar el producto del carrito: ${error.message}`);
                    });
            },
            procederAlPago() {
                if (!this.carrito || !this.carrito.items || this.carrito.items.length === 0) {
                    alert("Tu carrito esta vacio.");
                    return;
                }

                //Verificando que el cliente seleccione un metodo de pago identificando si alguna opción ha sido seleccionada y, dependiendo de esta selección, se le asigna un mensaje diferente.
                const metodoPago = document.querySelector('input[name="pago"]:checked');
                if (!metodoPago) {
                    alert("Por favor selecciona un método de pago.");
                    return;
                }

                let mensaje = "";
                switch (metodoPago.value) {
                    case "efectivo":
                        mensaje = "Por favor ten el dinero listo para entregárselo al repartidor.";
                        break;
                    case "tarjeta":
                        mensaje = "El repartidor llevará una terminal para procesar el pago.";
                        break;
                    case "transferencia":
                        mensaje = "Por favor realiza el depósito a la cuenta 638180010119946542 (nu bank/stp) con titular SazónFI Corporation.";
                        break;
                }

                // Guardando el mensaje
                const mensajeFinal = mensaje;

                if (!confirm("¿Estas seguro de que quieres finalizar tu pedido?")) {
                    return;
                }
                this.creandoPedido = true;
                fetch('/api/pedidos/crear/', {
                    method: 'POST',
                    headers: this.apiHeaders,
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json()
                                .then(errData => {
                                    const errorMessage = errData.detail || errData.error || JSON.stringify(errData);
                                    throw new Error(errorMessage || `Error del servidor: ${response.status}`);
                                })
                                .catch(() => {
                                    throw new Error(`Error del servidor: ${response.status}. Respuesta no es JSON.`);
                                });
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Pedido creado:', data);
                        alert(`¡Pedido realizado exitosamente! Tu carrito ha sido vaciado. \n\n${mensajeFinal}`);
                        this.fetchCarrito();
                    })
                    .catch(error => {
                        console.error('Error al crear el pedido:', error);
                        alert(`Error al realizar el pedido: ${error.message}`);
                    })
                    .finally(() => {
                        this.creandoPedido = false;
                    });
            }
        }
    });
</script>
{% endblock %}
